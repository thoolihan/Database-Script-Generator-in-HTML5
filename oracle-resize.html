<!doctype html>
<html>
  <head>
    <title>Oracle Downsize Script Generator</title>
    <link type="text/css" rel="stylesheet" href="dbsg.css" media="all">
    <meta name="viewport" content="width=device-width">
  </head>
  <body>
    <h1>Oracle Downsize Non-Empty Column</h1>
    <fieldset>
        <legend>Table Info</legend>

        <label for="table_name">Table</label>
        <input id="table_name" type="text" placeholder="MY_TABLE" autofocus="autofocus" />
        <input id="generate_script" type="button" value="Generate Script" /><br>

        <table id="foreign_keys" class="hidden">
           <thead>
                <th>table</th>
                <th>constraint</th>
                <th>actions</th>
           </thead>
        </table>

        <label for="fk_table_name">Associated Table with Foreign Key</label>
        <input id="fk_table_name" type="text" placeholder="TABLE_WITH_FK" />
        <label for="foreign_key_constraint">Foreign Key Constraint</label>
        <input id="foreign_key_constraint" type="text" placeholder="fk_my_constraint" />
        <input id="add_foreign_key" type="button" value="Add" />
    </fieldset>
    <div id="results" class="hidden"></div>
  </body>
  <script type="text/javascript" src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
  <script type="text/javascript" src="http://code.jquery.com/ui/1.8.17/jquery-ui.min.js"></script>
  <script type="text/javascript" src="http://ajax.microsoft.com/ajax/jquery.templates/beta1/jquery.tmpl.min.js"></script>

  <script id="foreign_key_template" type="text/x-jquery-tmpl">
      <tr id="fk${id}" class="fk">
        <td class="table">${table}</td>
        <td class="foreign_key">${foreign_key}</td>
        <td><a href="#" onclick="$('#fk${id}').remove()">remove</a></td>
      </tr>
  </script>

  <script id="script_template" type="text/x-jquery-tmpl">
--**************************************************************<br>
--Generated by hoolihan.net/blog-tim/oracle-fix<br>
--No warranty, run at your own risk<br>
--recommended that you run this line by line, not as a batch<br>
--take a backup first<br>
--**************************************************************<br>
<br>
--get a lock on the tables<br>
lock table ${table} in exclusive mode;<br>
{{each foreign_keys}}lock table ${$value.table} in exclusive mode;<br>{{/each}}
<br>
--disable any triggers so your primary keys don't get changed on reinsert<br>
alter table ${table} disable all triggers;<br>
<br>
--disable all foreign keys<br>
{{each foreign_keys}}alter table ${$value.table} disable constraint ${$value.constraint};<br>{{/each}}
<br>
--backup data as a temp table<br>
create table ${table}-temp-backup as select * from ${table};<br>
<br>
--truncate the table<br>
truncate table ${table};<br>
<br>
--TODO: COMPLETE THE ALTER STATEMENT HERE<br>
alter table ${table} modify (<br>
);<br>
<br>
--restore records from temp table<br>
insert into ${table} select * from ${table}-temp-backup;<br>
<br>
--enable all foreign keys<br>
{{each foreign_keys}}alter table ${$value.table} enable validate constraint ${$value.constraint};<br>{{/each}}
<br>
--enable triggers on the table<br>
alter table ${table} enable all triggers;<br>
<br>
--commit changes and release locks<br>
commit;<br>
<br>
--only run these next two lines after ensuring that everything worked<br>
--drop table ${table}-temp-backup;<br>
--commit;
  </script>
  <script type="text/javascript" src="script_gen.js"></script>
</html>



